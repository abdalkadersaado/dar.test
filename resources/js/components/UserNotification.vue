<template>
    <li class="dropdown">
        <a href="javascript:void(0)">
            <button class="dropbtn">
                <span class="product_qun" v-if="unreadCount > 0">{{
                    unreadCount
                }}</span>
                <svg
                    width="27"
                    height="27"
                    viewBox="0 0 27 27"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        d="M10.4062 21.6562V21.0937H6.18749C5.51644 21.0928 4.87312 20.8258 4.39862 20.3513C3.92411 19.8768 3.65714 19.2335 3.65624 18.5625V18.1327C3.65404 17.5975 3.80206 17.0724 4.08347 16.6172C4.36489 16.162 4.7684 15.7949 5.24812 15.5576C5.46271 15.4504 5.64623 15.29 5.78114 15.0916C5.91606 14.8933 5.99786 14.6637 6.01874 14.4247L6.52049 8.90096C6.61519 7.85868 6.94221 6.85086 7.47753 5.95156C8.01284 5.05226 8.74286 4.28433 9.61392 3.70419C10.485 3.12406 11.475 2.74647 12.5111 2.59916C13.5473 2.45185 14.6033 2.53858 15.6015 2.85296C15.293 3.33266 15.0526 3.85288 14.8871 4.39871C14.4345 4.27875 13.9682 4.21824 13.5 4.21871C12.1713 4.21247 10.8889 4.70673 9.90812 5.60311C8.92731 6.4995 8.31994 7.7323 8.20687 9.05621L7.70624 14.5777C7.65969 15.1033 7.47894 15.6082 7.18129 16.0439C6.88364 16.4797 6.47908 16.8317 6.00637 17.0662C5.80708 17.1643 5.63932 17.3164 5.52218 17.5051C5.40504 17.6939 5.34322 17.9117 5.34374 18.1338V18.5636C5.34434 18.7871 5.43346 19.0012 5.5916 19.1591C5.74973 19.3171 5.964 19.4059 6.18749 19.4062H20.8125C21.0362 19.4059 21.2506 19.3169 21.4088 19.1587C21.567 19.0006 21.6559 18.7861 21.6562 18.5625V18.1327C21.6571 17.9111 21.5958 17.6936 21.4793 17.5051C21.3627 17.3166 21.1956 17.1645 20.997 17.0662C20.5237 16.8321 20.1184 16.4803 19.8202 16.0445C19.5219 15.6088 19.3406 15.1037 19.2937 14.5777L19.0687 12.1252C19.6264 12.2887 20.2044 12.3724 20.7855 12.3738L20.9722 14.4236C20.995 14.6619 21.0776 14.8905 21.2126 15.0882C21.3475 15.2859 21.5304 15.4462 21.744 15.5542C22.2241 15.7916 22.6281 16.1588 22.91 16.6142C23.192 17.0696 23.3407 17.5949 23.3392 18.1305V18.5602C23.3386 19.2313 23.0718 19.8748 22.5972 20.3494C22.1226 20.824 21.4791 21.0909 20.808 21.0914H16.5937V21.6562C16.5937 22.4767 16.2678 23.2636 15.6876 23.8438C15.1074 24.424 14.3205 24.7499 13.5 24.7499C12.6795 24.7499 11.8926 24.424 11.3124 23.8438C10.7322 23.2636 10.4062 22.4767 10.4062 21.6562ZM12.0937 21.6562C12.0937 22.0292 12.2419 22.3868 12.5056 22.6506C12.7693 22.9143 13.127 23.0624 13.5 23.0624C13.873 23.0624 14.2306 22.9143 14.4944 22.6506C14.7581 22.3868 14.9062 22.0292 14.9062 21.6562V21.0937H12.0937V21.6562ZM20.5841 10.1182C19.9711 10.0828 19.375 9.90405 18.8437 9.5962L18.7942 9.05621C18.6741 7.66374 18.0075 6.37548 16.9402 5.47308C17.0476 4.89728 17.282 4.35268 17.6265 3.87896C18.4312 4.46526 19.1015 5.21651 19.5927 6.08253C20.084 6.94856 20.3847 7.90942 20.475 8.90096L20.5875 10.1171L20.5841 10.1182Z"
                        fill="#141124"
                    />
                    <path
                        d="M20.8125 10.125C20.0337 10.125 19.2725 9.89407 18.6249 9.46141C17.9774 9.02876 17.4727 8.4138 17.1747 7.69432C16.8767 6.97483 16.7987 6.18313 16.9507 5.41933C17.1026 4.65553 17.4776 3.95394 18.0283 3.40327C18.5789 2.8526 19.2805 2.47759 20.0443 2.32566C20.8081 2.17373 21.5998 2.25171 22.3193 2.54973C23.0388 2.84775 23.6538 3.35243 24.0864 3.99994C24.5191 4.64746 24.75 5.40874 24.75 6.1875C24.75 7.23179 24.3352 8.23331 23.5967 8.97173C22.8583 9.71016 21.8568 10.125 20.8125 10.125V10.125Z"
                        fill="#BA0F0F"
                    />
                </svg>
            </button>
        </a>
        <div class="dropdown-content-noti">
            <a
                href="#"
                class="drno io"
                style="height: 90px"
                v-for="item in unread"
                :key="item.id"
            >
                <div class="not" v-if="unreadCount > 0">
                    <svg
                        width="30px"
                        height="30px"
                        viewBox="0 0 512 512"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <path
                            d="M144 208C126.3 208 112 222.2 112 239.1C112 257.7 126.3 272 144 272s31.1-14.25 31.1-32S161.8 208 144 208zM256 207.1c-17.75 0-31.1 14.25-31.1 32s14.25 31.1 31.1 31.1s31.1-14.25 31.1-31.1S273.8 207.1 256 207.1zM368 208c-17.75 0-31.1 14.25-31.1 32s14.25 32 31.1 32c17.75 0 31.99-14.25 31.99-32C400 222.2 385.8 208 368 208zM256 31.1c-141.4 0-255.1 93.12-255.1 208c0 47.62 19.91 91.25 52.91 126.3c-14.87 39.5-45.87 72.88-46.37 73.25c-6.624 7-8.373 17.25-4.624 26C5.818 474.2 14.38 480 24 480c61.49 0 109.1-25.75 139.1-46.25c28.87 9 60.16 14.25 92.9 14.25c141.4 0 255.1-93.13 255.1-207.1S397.4 31.1 256 31.1zM256 400c-26.75 0-53.12-4.125-78.36-12.12l-22.75-7.125L135.4 394.5c-14.25 10.12-33.87 21.38-57.49 29c7.374-12.12 14.37-25.75 19.87-40.25l10.62-28l-20.62-21.87C69.81 314.1 48.06 282.2 48.06 240c0-88.25 93.24-160 207.1-160s207.1 71.75 207.1 160S370.8 400 256 400z"
                        />
                    </svg>
                    <div class="coty">
                        <p class="date">{{ item.data.created_at }}</p>

                        <a
                            :href="`/comment-on/${item.data.financial_report_id}`"
                            @click="readNotifications(item)"
                        >
                            <p class="yue">
                                {{
                                    trans("notification.user_new_comment", {
                                        post_title: item.data.name,
                                    })
                                }}
                            </p>
                        </a>
                    </div>
                </div>
            </a>
        </div>
    </li>
</template>

<script>
export default {
    data: function () {
        return {
            read: {},
            unread: {},
            unreadCount: 0,
        };
    },
    created: function () {
        let userId = $('meta[name="userId"]').attr("content");
        if (userId != "") {
            this.getNotifications();

            Echo.private("App.User." + userId).notification((notification) => {
                this.unread.unshift(notification);
                this.unreadCount++;
            });
        }
    },
    methods: {
        getNotifications() {
            axios
                .get("/user/notifications/get")
                .then((res) => {
                    this.read = res.data.read;
                    this.unread = res.data.unread;
                    this.unreadCount = res.data.unread.length;
                })
                .catch((error) => Exception.handle(error));
        },
        readNotifications(notification) {
            axios
                .post("/user/notifications/read", { id: notification.id })
                .then((res) => {
                    this.unread.splice(notification, 1);
                    this.read.push(notification);
                    this.unreadCount--;
                });
        },
    },
};
</script>
